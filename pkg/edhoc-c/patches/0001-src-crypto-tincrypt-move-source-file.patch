From cfc2ffed6dadcbc26cc0f120d639a823520596cf Mon Sep 17 00:00:00 2001
From: Francisco Molina <femolina@uc.cl>
Date: Wed, 21 Apr 2021 10:40:38 +0200
Subject: [PATCH 1/3] src/crypto/tincrypt: move source file

---
 src/crypto.h                           |  4 ++--
 src/crypto/{tinycrypt => }/tinycrypt.c | 17 ++++++++++-------
 2 files changed, 12 insertions(+), 9 deletions(-)
 rename src/crypto/{tinycrypt => }/tinycrypt.c (93%)

diff --git a/src/crypto.h b/src/crypto.h
index 4ce6350..16902fc 100644
--- a/src/crypto.h
+++ b/src/crypto.h
@@ -17,9 +17,9 @@ struct hacl_Sha256 {
     uint16_t fillLevel;
     uint8_t buffer[HASH_INPUT_BLEN];
 };
+#elif defined(MODULE_TINYCRYPT)
+#include "tinycrypt/sha256.h"
 #elif defined(EMPTY_CRYPTO)
-#elif defined(TINYCRYPT)
-#include "crypto/tinycrypt/sha256.h"
 #else
 #error "No crypto backend selected"
 #endif
diff --git a/src/crypto/tinycrypt/tinycrypt.c b/src/crypto/tinycrypt.c
similarity index 93%
rename from src/crypto/tinycrypt/tinycrypt.c
rename to src/crypto/tinycrypt.c
index 9dafb3c..6a822b4 100644
--- a/src/crypto/tinycrypt/tinycrypt.c
+++ b/src/crypto/tinycrypt.c
@@ -6,21 +6,24 @@
 
 #if defined(TINYCRYPT)
 
-#include "constants.h"
+#include "tinycrypt/constants.h"
+#include "tinycrypt/hmac.h"
+#include "tinycrypt/hkdf.h"
+#include "tinycrypt/ccm_mode.h"
 #include "edsign.h"
-#include "hmac.h"
 #include "c25519.h"
-#include "hkdf.h"
-#include "ccm_mode.h"
+#include "random.h"
 
 int crypt_gen_keypair(cose_curve_t crv, cose_key_t *key) {
     (void) crv;
-    (void) key;
-    return EDHOC_ERR_RANDOMNESS;
+    random_bytes(key->d, C25519_EXPONENT_SIZE);
+    c25519_prepare(key->d);
+    c25519_smult(key->x, c25519_base_x, key->d);
+    return EDHOC_SUCCESS;
 }
 
 int crypt_copy_hash_context(void *dstCtx, void *srcCtx) {
-    memcpy(dstCtx, srcCtx, sizeof(struct tc_sha256_state_struct ));
+    memcpy(dstCtx, srcCtx, sizeof(struct tc_sha256_state_struct));
 
     return EDHOC_SUCCESS;
 }
-- 
2.28.0

